<?php
/**
 * Validation.class file
 * @filesource ./ORM/Validation.class 
 */
/**
 * Description of Validation
 *
 * @category  Class
 * @package    ORM
 * @author    bryyce
 * @license    http://www.gnu.org/copyleft/gpl.html GNU General Public License
 * @link    http://www.bryyce.fr/
 */

namespace ORM;

class Validation {

	public static function validate($entity, array $validation, $id) {
      foreach ($validation as $test => $values) {
			switch ($test) {
				case 'unique':
					foreach ($values as $value)
						if ($entity::count(array($value => $entity->$value), 'and ' . $id . ' != ' . $entity->$id))
							$entity->errors[$value] = 'not unique';
					break;
				case 'presence':
					foreach ($values as $value)
						if (self::isEmpty($entity->$value))
							$entity->errors[$value] = 'is empty';
					break;
				case 'numericality':
					foreach ($values as $value)
						if (!self::isNumeric($entity->$value))
							$entity->errors[$value] = 'is not numeric';
					break;
				case 'length':
					$value = key($values);
					if(is_array($values[$value])){
						$size = $values[$value];
						if (strlen($entity->$value) < $size)
							$entity->errors[$value] = 'is too long (< '.$size.')';
					}
					else{
						switch(key($values[$value])){
							case 'gt':
								if (strlen($entity->$value) < $values[$value]['gt'])
									$entity->errors[$value] = 'is too long (< '.$values[$value]['gt'].')';
								break;
							case 'lt':
								if (strlen($entity->$value) > $values[$value]['lt'])
									$entity->errors[$value] = 'is too short (> '.$values[$value]['lt'].')';								
								break;
							case 'between':
								if (strlen($entity->$value) > $values[$value]['between'][0] &&
										  strlen($entity->$value) < $values[$value]['between'][1])
									$entity->errors[$value] = 'is not between ( '.$values[$value]['between'][0].' and '.$values[$value]['between'][1].')';								
								break;
						}
					}
					break;
			}
		}
		return count($entity->errors) > 0;
	}

	public static function isNumeric($param) {
		return preg_match("#^-?\d+.?\d+$#", $param);
	}

	public static function isInteger($param) {
		return preg_match("#^-?\d+$#", $param);
	}

	public static function isEmpty($param) {
		return $param === null || $param === "";
	}

	public static function isUnique($param) {
		return $param;
	}

}

?>
